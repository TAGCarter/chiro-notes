v<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive Chiropractic Listing Template - v2.8 (Phase 1)</title>
  <style>
    /* ===== Base / Layout ===== */
    :root {
      --ink:#2c5282; --ink2:#4a5568; --bg:#f4f7fa; --card:#fff; --line:#d1d9e6; --sel:#b3e6b3; --hover:#b3d4ff; --brand:#4a90e2; --brand2:#357abd;
    }
    html,body{height:100%}
    body{margin:20px;font-family:'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:#333}
    h1{color:var(--ink);margin:0 0 14px}
    h3{color:var(--ink);margin:0 0 10px;text-align:center}
    h4{color:var(--ink2);margin:0 0 8px}

    .top-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
    .button{padding:8px 14px;background:var(--brand);color:#fff;border:0;border-radius:6px;cursor:pointer;font-size:14px}
    .button:hover{background:var(--brand2)}

    .column-container{display:flex;gap:20px}
    .col{flex:1 1 0;border:1px solid var(--line);background:var(--card);border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.08);padding:14px;min-height:200px}
    .col-bones{flex:1 1 25%}
    .col-listings{flex:1 1 35%}
    .col-soap{flex:1 1 40%}

    .section{margin-bottom:16px}
    .section-header{cursor:pointer;font-weight:700;color:var(--ink);padding:10px 12px;background:#c7eaff;border:1px solid #b3c7f7;border-radius:8px;transition:.25s}
    .section-header:hover{background:#a8d1ff}

    /* ===== Selectables ===== */
    .selectable,.selection-button{cursor:pointer;background:#e8f0fe;padding:8px;margin:6px 0;border:1px solid #b3c7f7;border-radius:6px;transition:.2s;position:relative}
    .selectable:hover:not(.selected),.selection-button:hover:not(.selected){background:var(--hover)}
    .selected{background:var(--sel)!important;border-color:#4caf50!important}
    .group{margin-bottom:10px}

    /* ===== Row Builder (Phase 1) ===== */
    .rb-wrap{margin:16px 0;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .rb-bar{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;align-items:center}
    .rb-left{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .rb-badge{display:inline-flex;gap:6px;align-items:center;background:#e8f0fe;border:1px solid #b3c7f7;border-radius:999px;padding:6px 10px;font-size:13px;color:var(--ink)}
    .rb-actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn-sm{padding:6px 10px;font-size:13px;border-radius:6px;border:1px solid #cbd5e0;background:#f7fafc;cursor:pointer}
    .btn-sm.primary{background:var(--brand);border-color:var(--brand2);color:#fff}
    .btn-sm:disabled{opacity:.5;cursor:not-allowed}

    .saved-wrap{margin:16px 0;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .saved-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .saved-list{list-style:none;margin:0;padding:0}
    .saved-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:8px 10px;margin-bottom:6px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px}
    .icon-btn{border:1px solid #cbd5e0;background:#fff;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px}
    .icon-btn:hover{background:#edf2f7}
    .saved-text{font-size:14px;color:#2d3748}

    /* ===== Custom boxes (top of columns) ===== */
    .custom-box{display:flex;gap:6px;margin-bottom:8px}
    .custom-box input{flex:1;padding:6px 8px;border:1px solid var(--line);border-radius:6px;font-size:13px}
    .custom-box button{padding:6px 10px;font-size:13px;border-radius:6px;border:1px solid #cbd5e0;background:#f7fafc;cursor:pointer}

    /* ===== SOAP ===== */
    .soap-card{border:1px dashed var(--line);border-radius:10px;padding:10px}
    .soap-header{cursor:pointer;color:var(--ink);font-weight:700;margin:10px 0 6px}
    .soap-area{width:100%;height:120px;resize:vertical;border:1px solid var(--line);border-radius:6px;padding:8px;font-size:14px;box-sizing:border-box}
    .active-section{outline:2px solid #4caf50}

    /* ===== Desktop-only gate ===== */
    .desktop-only-overlay{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,.8);color:#fff;z-index:5000;text-align:center;padding:24px}
    .desktop-only-overlay .card{background:#1a202c;padding:24px;border-radius:12px;max-width:520px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
    .desktop-only-overlay h2{margin:0 0 8px;font-size:22px}
    @media (max-width:1023px){.desktop-only-overlay{display:flex}.app-wrap{display:none!important}}
  </style>
</head>
<body>
  <!-- Desktop-only overlay -->
  <div class="desktop-only-overlay"><div class="card"><h2>Desktop Only</h2><p>Please open this tool on a desktop or laptop (≥1024px wide).</p></div></div>

  <div class="app-wrap">
    <div class="top-buttons">
      <button id="btn-undo" class="button" title="Undo">Undo</button>
      <button id="btn-redo" class="button" title="Redo">Redo</button>
      <button id="btn-clear-all" class="button" title="Clear saved rows & selections">Clear All</button>
      <button id="btn-export-text" class="button" title="Export human‑readable text">Export .txt</button>
      <button id="btn-export-json" class="button" title="Export restorable JSON">Export .json</button>
      <label for="import-json-input" class="button" style="cursor:pointer">Import .json</label>
      <input id="import-json-input" type="file" accept="application/json" style="display:none" />
    </div>

    <h1>Interactive Chiropractic Listing Template</h1>

    <!-- Phase 1 Row Builder -->
    <div class="rb-wrap">
      <div class="rb-bar">
        <div class="rb-left" id="rb-badges">
          <span class="rb-badge"><strong>Bone:</strong>&nbsp;<span data-rb="bone">—</span></span>
          <span class="rb-badge"><strong>Listing:</strong>&nbsp;<span data-rb="listing">—</span></span>
          <span class="rb-badge"><strong>Positions:</strong>&nbsp;<span data-rb="positions">—</span></span>
          <span class="rb-badge"><strong>Contacts:</strong>&nbsp;<span data-rb="contacts">—</span></span>
          <span class="rb-badge"><strong>Types:</strong>&nbsp;<span data-rb="types">—</span></span>
          <span class="rb-badge"><strong>Protocols:</strong>&nbsp;<span data-rb="protocols">—</span></span>
        </div>
        <div class="rb-actions">
          <button class="btn-sm" id="btn-clear-pending" title="Clear current selections">Clear</button>
          <button class="btn-sm primary" id="btn-add-row" disabled>Add Row</button>
        </div>
      </div>
    </div>

    <!-- Saved lines -->
    <div class="saved-wrap">
      <div class="saved-header"><h4 style="margin:0;color:var(--ink)">Saved Entries</h4></div>
      <ul id="saved-list" class="saved-list"></ul>
    </div>

    <div class="column-container">
      <!-- Bones / Areas -->
      <div class="col col-bones">
        <h3>Select Area / Category</h3>
        <div id="bones"></div>
      </div>

      <!-- Listings / Adjustments -->
      <div class="col col-listings">
        <h3>Listings & Adjustments</h3>
        <div class="section listings-section">
          <div class="custom-box"><input placeholder="Add custom listing…"><button type="button" data-add-custom="listings">Add</button></div>
          <h4>Listings</h4>
          <div id="listings"></div>
        </div>
        <div class="section positions-section">
          <div class="custom-box"><input placeholder="Add custom position…"><button type="button" data-add-custom="positions">Add</button></div>
          <h4>Patient position</h4>
          <div id="positions"></div>
        </div>
        <div class="section contacts-section">
          <div class="custom-box"><input placeholder="Add custom contact…"><button type="button" data-add-custom="contacts">Add</button></div>
          <h4>Contact</h4>
          <div id="contacts"></div>
        </div>
        <div class="section types-section">
          <div class="custom-box"><input placeholder="Add custom type…"><button type="button" data-add-custom="types">Add</button></div>
          <h4>Type of adjustment</h4>
          <div id="types"></div>
        </div>
        <div class="section protocols-section">
          <div class="custom-box"><input placeholder="Add custom protocol…"><button type="button" data-add-custom="protocols">Add</button></div>
          <h4>Cranial protocols</h4>
          <div id="protocols"></div>
        </div>
        <div class="section sot-section">
          <div class="custom-box"><input placeholder="Add custom SOT…"><button type="button" data-add-custom="sot">Add</button></div>
          <h4>SOT</h4>
          <div id="sot"></div>
        </div>
      </div>

      <!-- SOAP -->
      <div class="col col-soap">
        <h3>SOAP Notes</h3>
        <!-- Patient name intentionally omitted per requirement -->
        <div class="soap-card">
          <div class="soap-header" data-soap="S">SUBJECTIVE</div>
          <textarea id="soap-S" class="soap-area" placeholder="Subjective notes…"></textarea>
          <div class="soap-header" data-soap="O">OBJECTIVE FINDINGS</div>
          <textarea id="soap-O" class="soap-area" placeholder="Objective findings…"></textarea>
          <div class="soap-header" data-soap="A">ACTION</div>
          <textarea id="soap-A" class="soap-area" placeholder="Actions performed…"></textarea>
          <div class="soap-header" data-soap="P">PLAN</div>
          <textarea id="soap-P" class="soap-area" placeholder="Plan…"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ==========================
       Data (subset preserved from your v2.7)
       ========================== */
    const listingsData = {
      'Cranial Bones': {
        commonListings: [
          { text:'LEFT', tooltip:'Left-sided adjustment' },
          { text:'RIGHT', tooltip:'Right-sided adjustment' },
          { text:'Bilateral', tooltip:'Both sides adjusted' },
          { text:'Flexion', tooltip:'Forward tilt adjustment' },
          { text:'Extension', tooltip:'Backward tilt adjustment' },
          { text:'Inferior', tooltip:'Downward adjustment' },
          { text:'Superior', tooltip:'Upward adjustment' }
        ],
        commonTypes: [
          { text:'Neuro-Interlink Reflex', tooltip:'Reflex-based correction' },
          { text:'hold release', tooltip:'Gentle hold and release technique for cranial sutures' },
          { text:'finger toggle', tooltip:'A gentle hold with torque followed by a HVLA thrust' },
          { text:'CSF guided release', tooltip:'Cerebrospinal fluid guided release technique' }
        ],
        commonProtocols: [
          { text:'Howat 8 step Protocol', tooltip:'Cranial detorque correction' },
          { text:'Carter Nose correction protocol', tooltip:'Nasal structure correction' },
          { text:'Carter Sphenoid correction', tooltip:'Protocol for sphenoid bone correction' }
        ],
        'Occipital': {
          positions: [
            { text:'Occipito-mastoid suture' },
            { text:'Lamboidal suture' }
          ]
        },
        'Sphenoid': {
          positions: [
            { text:'Pterion' },
            { text:'Spheno-parietal Suture' },
            { text:'Spheno-frontal Suture' },
            { text:'Spheno-squamous Suture' },
            { text:'Spheno-zygomatic suture' }
          ]
        },
        'Maxilla': {
          positions: [
            { text:'Inter Maxillary Suture' },
            { text:'Median Palatine Suture' },
            { text:'Transverse Palatine suture' },
            { text:'Incisive suture' },
            { text:'Zygomatico-maxillary suture' },
            { text:'Lacrimo-maxillary suture' },
            { text:'Fronto maxillary suture' },
            { text:'Naso-maxillary suture' }
          ]
        },
        'Frontal': {
          positions: [
            { text:'Sagittal Suture' },
            { text:'Frontal Suture' },
            { text:'Frontonasal suture' },
            { text:'Fronto maxillary suture' },
            { text:'Fronto-lacrimal suture' },
            { text:'Fronto-zygomatic suture' },
            { text:'CCJ cranial detorque protocol' }
          ]
        },
        'Parietal': {
          positions: [
            { text:'Sagittal Suture' },
            { text:'Squamous Suture' },
            { text:'Spheno-parietal Suture' },
            { text:'Parietomas-toid Suture' },
            { text:'Lamboidal suture' }
          ]
        },
        'Temporal': {
          positions: [
            { text:'Squamous Suture' },
            { text:'Temporo-zygomatic suture' },
            { text:'Spheno-squamous Suture' },
            { text:'Occipito-mastoid suture' },
            { text:'Parietomas-toid Suture' },
            { text:'TMJ' }
          ]
        },
        'Zygomatic': {
          positions: [
            { text:'Temporo-zygomatic suture' },
            { text:'Spheno-zygomatic suture' },
            { text:'Zygomatico-maxillary suture' },
            { text:'Fronto-zygomatic suture' }
          ]
        },
        'Ethmoid': {
          positions: [
            { text:'Internasal suture' },
            { text:'Nose protocol' },
            { text:'Nasal cartilage' }
          ]
        },
        'Vomer': { positions: [ { text:'Median Palatine Suture' }, { text:'Gum release' } ] },
        'Mandible': { positions: [ { text:'TMJ AI/PS' }, { text:'Mentalis Suture' }, { text:'Gum release' } ] }
      },

      'Cervical': {
        'Occiput': {
          listings: [
            { text:'PS' },{ text:'PS-LS' },{ text:'PS-RS' },{ text:'AS' },{ text:'AS-LS' },{ text:'AS-RS' },
            { text:'Left posterior Facet' },{ text:'Right posterior Facet' },{ text:'Bilateral posterior Facet' }
          ],
          positions: [ { text:'Prone' },{ text:'Supine' },{ text:'Seated' },{ text:'Side posture' },{ text:'Side Posture Toggle Recoil with drop' } ],
          types: [ { text:'Osseous' },{ text:'De-compression' },{ text:'Toggle Recoil' },{ text:'Finger toggle' },{ text:'Drop' },{ text:'Hold' },{ text:'Dural Breath' } ]
        },
        'C1/Atlas': {
          listings: [
            { text:'ASR' },{ text:'ASR-P' },{ text:'ASR-A' },{ text:'PIR' },{ text:'PIR-P' },{ text:'PIR-A' },
            { text:'ASL' },{ text:'ASL-P' },{ text:'ASL-A' },{ text:'PIL' },{ text:'PIL-P' },{ text:'PIL-A' },
            { text:'Left posterior Facet' },{ text:'Right posterior Facet' },{ text:'Bilateral posterior Facet' },
            { text:'Left anterior Facet' },{ text:'Right anterior Facet' },{ text:'Bilateral anterior Facet' }
          ],
          positions: [ { text:'Prone' },{ text:'Supine' },{ text:'Seated' },{ text:'Side posture' } ],
          contacts: [ { text:'TVP contact' },{ text:'Posteior arch contact' } ],
          types: [
            { text:'Side Posture Toggle Recoil with drop' },{ text:'Osseous' },{ text:'Toggle Recoil' },{ text:'Finger toggle' },{ text:'Hold' },{ text:'Drop' },{ text:'Dural Breath' },{ text:'Coupled Motion' },{ text:'Lateral flexion' },{ text:'Rotation' },{ text:'De-compression' },{ text:'Pull' },{ text:'NUCCA' }
          ]
        },
        'C2-7': {
          listings: [
            { text:'Left posterior Facet' },{ text:'Right posterior Facet' },{ text:'Bilateral posterior Facet' },
            { text:'ASR-la' },{ text:'ASL-la' },{ text:'PR' },{ text:'PRS' },{ text:'PRI-la' },{ text:'PL' },{ text:'PLS' },{ text:'PLI-la' },{ text:'A2N' },{ text:'AL Disc' },{ text:'AR Disc' },{ text:'AL Facet' },{ text:'AR Facet' }
          ],
          positions: [ { text:'Prone' },{ text:'Supine' },{ text:'Seated' },{ text:'Side posture' } ],
          contacts: [ { text:'TVP contact' },{ text:'SP contact' },{ text:'Lamina contact' },{ text:'Articular pillar contact' } ],
          types: [ { text:'Osseous' },{ text:'Side Posture Toggle Recoil with drop' },{ text:'Drop' },{ text:'Toggle Recoil' },{ text:'Finger toggle' },{ text:'Hold' },{ text:'Dural Breath' },{ text:'Coupled Motion' },{ text:'Lateral flexion' },{ text:'Rotation' },{ text:'De-compression' },{ text:'Pull' } ]
        }
      },

      'Thoracic': {
        listings: [ { text:'Bilateral Facet' },{ text:'Left facet' },{ text:'Right facet' },{ text:'Left Rib' },{ text:'Right Rib' },{ text:'PR' },{ text:'PRS' },{ text:'PRI-t' },{ text:'PL' },{ text:'PLS' },{ text:'PLI-t' },{ text:'Left side slip' },{ text:'Right side slip' },{ text:'Anterior' },{ text:'AR' },{ text:'ARS' },{ text:'ARI-t' },{ text:'AL' },{ text:'ALI-t' },{ text:'Anterior Rib Cartilage' },{ text:'Left posterior Facet' },{ text:'Right posterior Facet' },{ text:'Bilateral posterior Facet' } ],
        positions: [ { text:'Prone' },{ text:'Supine' },{ text:'Standing' },{ text:'Seated' } ],
        contacts: [ { text:'X Bilateral' },{ text:'Double thenar' },{ text:'Unilateral Reinforced' },{ text:'TVP contact' },{ text:'SP contact' },{ text:'Thumb Contact' },{ text:'Double Finger Reinforced' },{ text:'ABC roll' },{ text:'Anterior Thoracic' } ],
        types: [ { text:'Osseous' },{ text:'Drop' },{ text:'Finger Toggle' },{ text:'Hold' },{ text:'Dural Breath' },{ text:'Inhalation' },{ text:'Expiration' } ]
      },

      'Lumbar': {
        listings: [ { text:'Left posterior Facet' },{ text:'Right posterior Facet' },{ text:'PR' },{ text:'PRS' },{ text:'PRI-m' },{ text:'PL' },{ text:'PLS' },{ text:'PLI-m' },{ text:'Anterior' } ],
        positions: [ { text:'Side posture' },{ text:'Prone' },{ text:'Supine' },{ text:'Standing' } ],
        contacts: [ { text:'SP contact' },{ text:'Mammillary contact' } ],
        types: [ { text:'Osseous' },{ text:'Push move' },{ text:'Pull move' },{ text:'Coupled Motion' },{ text:'ISU' },{ text:'ISD' },{ text:'Drop' },{ text:'Finger Toggle' },{ text:'Hold' },{ text:'Dural Breath' },{ text:'ABC roll' } ]
      },

      'Pelvis': {
        listings: [ { text:'PI' },{ text:'PIIn' },{ text:'PIEx' },{ text:'AS' },{ text:'ASIn' },{ text:'ASEx' },{ text:'Ex' },{ text:'In' },{ text:'Ex/In' },{ text:'In/Ex' } ],
        positions: [ { text:'Side posture' },{ text:'Prone' },{ text:'Supine' },{ text:'Standing' } ],
        types: [ { text:'Osseous' },{ text:'Drop' },{ text:'Blocked' },{ text:'Finger toggle' },{ text:'Hold' },{ text:'Dural Breath' },{ text:'Push move' },{ text:'Pull move' },{ text:'Pump' } ]
      }
      // You can extend with Sacrum & coccyx, Extremities, Zones similarly
    };

    /* ==========================
       State
       ========================== */
    let selectedBone = '';// string like 'C1/Atlas' or 'Frontal'
    let selectedCategory = '';// top-level like 'Cervical' or 'Cranial Bones'
    let selectedListings = [];
    let selectedPositions = [];
    let selectedContacts = [];
    let selectedTypes = [];
    let selectedProtocols = [];

    // Phase 1: rows + history
    let savedRows = [];
    let editingIndex = null;
    let undoStack = [];
    let redoStack = [];

    /* ==========================
       DOM helpers
       ========================== */
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

    function btn(text, cls='selection-button'){
      const d=document.createElement('div');
      d.className=cls; d.textContent=text; return d;
    }

    function badgeUpdate(){
      const set=(k,v)=>{ const el=$(`[data-rb="${k}"]`); if(!el) return; if(Array.isArray(v)) el.textContent=v.length? v.join(', '):'—'; else el.textContent=v||'—'; };
      set('bone', selectedBone);
      set('listing', selectedListings[0]||'—');
      set('positions', selectedPositions);
      set('contacts', selectedContacts);
      set('types', selectedTypes);
      set('protocols', selectedProtocols);
      $('#btn-add-row')?.toggleAttribute('disabled', !(selectedBone && selectedListings.length));
    }

    function clearPending(){
      selectedBone=''; selectedCategory='';
      selectedListings=[]; selectedPositions=[]; selectedContacts=[]; selectedTypes=[]; selectedProtocols=[];
      $$('.selected').forEach(x=>x.classList.remove('selected'));
      $('#listings').innerHTML=''; $('#positions').innerHTML=''; $('#contacts').innerHTML=''; $('#types').innerHTML=''; $('#protocols').innerHTML=''; $('#sot').innerHTML='';
      badgeUpdate();
      const btn=$('#btn-add-row'); if(btn) btn.textContent='Add Row';
    }

    /* ==========================
       Renderers
       ========================== */
    function renderBones(){
      const host=$('#bones'); host.innerHTML='';
      Object.keys(listingsData).forEach(sectionName=>{
        const section=listingsData[sectionName];
        const wrap=document.createElement('div'); wrap.className='group';
        const hdr=document.createElement('div'); hdr.className='section-header'; hdr.textContent=sectionName; wrap.appendChild(hdr);
        const inner=document.createElement('div'); inner.style.marginTop='8px'; wrap.appendChild(inner);

        // For Cranial, show sub-bones; for others, show their keys or the section itself
        const subKeys=Object.keys(section).filter(k=>!['commonListings','commonTypes','commonProtocols'].includes(k));
        if(subKeys.length && typeof section[subKeys[0]] === 'object' && !Array.isArray(section[subKeys[0]]) ){
          subKeys.forEach(sub=>{
            const b=btn(sub,'selectable');
            b.addEventListener('click',()=>{
              // Select bone (single-select)
              $$('#bones .selected').forEach(x=>x.classList.remove('selected')); b.classList.add('selected');
              selectedBone=sub; selectedCategory=sectionName; badgeUpdate();
              renderRightPanelFor(sectionName, sub);
            });
            inner.appendChild(b);
          });
        } else {
          // No sub-keys: treat the section itself as a selectable
          const b=btn(sectionName,'selectable');
          b.addEventListener('click',()=>{
            $$('#bones .selected').forEach(x=>x.classList.remove('selected')); b.classList.add('selected');
            selectedBone=sectionName; selectedCategory=sectionName; badgeUpdate();
            renderRightPanelFor(sectionName, null);
          });
          inner.appendChild(b);
        }
        host.appendChild(wrap);
      });
    }

    function renderRightPanelFor(sectionName, sub){
      // Reset current picks for right panel groups
      selectedListings=[]; selectedPositions=[]; selectedContacts=[]; selectedTypes=[]; selectedProtocols=[];
      ['listings','positions','contacts','types','protocols','sot'].forEach(id=>$('#'+id).innerHTML='');

      const section=listingsData[sectionName];
      const block=sub? section[sub] : section;

      // Listings
      const listingsHost=$('#listings');
      const listings=(block && block.listings) || (section.commonListings) || [];
      listings.forEach(it=>{
        const d=btn(it.text||it);
        d.addEventListener('click',()=>{
          // single-select for listing
          $$('#listings .selected').forEach(x=>{if(x!==d) x.classList.remove('selected')});
          d.classList.toggle('selected');
          selectedListings=$$('#listings .selected').map(x=>x.textContent.trim());
          badgeUpdate();
        });
        listingsHost.appendChild(d);
      });

      // Positions
      const positionsHost=$('#positions');
      const positions=(block && block.positions) || [];
      positions.forEach(it=>{
        const d=btn(it.text||it);
        d.addEventListener('click',()=>{
          d.classList.toggle('selected');
          selectedPositions=$$('#positions .selected').map(x=>x.textContent.trim());
          badgeUpdate();
        });
        positionsHost.appendChild(d);
      });

      // Contacts
      const contactsHost=$('#contacts');
      const contacts=(block && block.contacts) || [];
      contacts.forEach(it=>{
        const d=btn(it.text||it);
        d.addEventListener('click',()=>{
          d.classList.toggle('selected');
          selectedContacts=$$('#contacts .selected').map(x=>x.textContent.trim());
          badgeUpdate();
        });
        contactsHost.appendChild(d);
      });

      // Types
      const typesHost=$('#types');
      const types=(block && block.types) || (section.commonTypes) || [];
      types.forEach(it=>{
        const d=btn(it.text||it);
        d.addEventListener('click',()=>{
          d.classList.toggle('selected');
          selectedTypes=$$('#types .selected').map(x=>x.textContent.trim());
          badgeUpdate();
        });
        typesHost.appendChild(d);
      });

      // Protocols
      const protocolsHost=$('#protocols');
      const protocols=(block && block.protocols) || (section.commonProtocols) || [];
      protocols.forEach(it=>{
        const d=btn(it.text||it);
        d.addEventListener('click',()=>{
          d.classList.toggle('selected');
          selectedProtocols=$$('#protocols .selected').map(x=>x.textContent.trim());
          badgeUpdate();
        });
        protocolsHost.appendChild(d);
      });

      // SOT (if present)
      const sotHost=$('#sot');
      const sot=(block && block.sot) || [];
      sot.forEach(it=>{
        const d=btn(it.text||it);
        d.addEventListener('click',()=>{ d.classList.toggle('selected'); badgeUpdate(); });
        sotHost.appendChild(d);
      });

      badgeUpdate();
    }

    /* ==========================
       Phase 1: rows + history + persistence
       ========================== */
    function buildLineText(row){
      const j=a=>a&&a.length? a.join(', '):null;
      return [row.bone,row.listing,j(row.positions),j(row.contacts),j(row.types),j(row.protocols)].filter(Boolean).join(' — ');
    }

    function renderSaved(){
      const ul=$('#saved-list'); ul.innerHTML='';
      savedRows.forEach((row,idx)=>{
        const li=document.createElement('li'); li.className='saved-item';
        li.innerHTML=`<div class="saved-text">${buildLineText(row)}</div>
          <div>
            <button class="icon-btn" data-edit="${idx}">✎ Edit</button>
            <button class="icon-btn" data-del="${idx}">🗑️ Delete</button>
          </div>`;
        ul.appendChild(li);
      });
    }

    function pushHistory(action){ undoStack.push(action); redoStack=[]; }

    function addRow(){
      if(!(selectedBone && selectedListings.length)) return;
      const row={
        id:crypto.randomUUID?crypto.randomUUID():String(Date.now()+Math.random()),
        bone:selectedBone, listing:selectedListings[0],
        positions:selectedPositions.slice(0), contacts:selectedContacts.slice(0), types:selectedTypes.slice(0), protocols:selectedProtocols.slice(0)
      };
      if(editingIndex!==null){
        const prev={...savedRows[editingIndex]};
        savedRows[editingIndex]=row; pushHistory({type:'edit',index:editingIndex,prev,next:{...row}}); editingIndex=null;
        $('#btn-add-row').textContent='Add Row';
      } else {
        savedRows.push(row); pushHistory({type:'add',index:savedRows.length-1,row:{...row}});
      }
      persist(); renderSaved(); clearPending();
    }

    function delRow(idx){ const [removed]=savedRows.splice(idx,1); pushHistory({type:'delete',index:idx,row:removed}); persist(); renderSaved(); }
    function loadRow(idx){ const row=savedRows[idx]; if(!row) return; clearPending();
      // select category & bone
      // Find which section contains this bone
      let secName=selectedCategory; // default
      Object.keys(listingsData).forEach(name=>{ if(listingsData[name][row.bone]) secName=name; });
      selectedCategory=secName; selectedBone=row.bone;
      // visually select in bones panel
      $$('#bones .selectable').forEach(el=>{ if(el.textContent.trim()===row.bone) el.classList.add('selected'); else el.classList.remove('selected'); });
      renderRightPanelFor(secName,row.bone);
      // apply right panel selections
      function selectIn(hostId, values){ values.forEach(v=>{ $(`#${hostId}`)?.querySelectorAll('.selection-button')?.forEach(el=>{ if(el.textContent.trim()===v) el.classList.add('selected'); }); }); }
      selectedListings=[row.listing]; selectIn('listings',[row.listing]);
      selectedPositions=row.positions||[]; selectIn('positions',selectedPositions);
      selectedContacts=row.contacts||[]; selectIn('contacts',selectedContacts);
      selectedTypes=row.types||[]; selectIn('types',selectedTypes);
      selectedProtocols=row.protocols||[]; selectIn('protocols',selectedProtocols);
      editingIndex=idx; badgeUpdate(); $('#btn-add-row').textContent='Save Changes';
    }

    function undo(){ const a=undoStack.pop(); if(!a) return; switch(a.type){
      case 'add': savedRows.splice(a.index,1); redoStack.push(a); break;
      case 'edit': savedRows[a.index]=a.prev; redoStack.push(a); break;
      case 'delete': savedRows.splice(a.index,0,a.row); redoStack.push(a); break;
      case 'import': savedRows=a.prev; redoStack.push(a); break;
    } persist(); renderSaved(); }
    function redo(){ const a=redoStack.pop(); if(!a) return; switch(a.type){
      case 'add': savedRows.splice(a.index,0,a.row); break;
      case 'edit': savedRows[a.index]=a.next; break;
      case 'delete': savedRows.splice(a.index,1); break;
      case 'import': /* re-apply? no-op here */ break;
    } undoStack.push(a); persist(); renderSaved(); }

    function persist(){ try{ localStorage.setItem('chiroNotes_phase1', JSON.stringify({savedRows})); }catch(e){} }
    function restore(){ try{ const raw=localStorage.getItem('chiroNotes_phase1'); if(!raw) return; const d=JSON.parse(raw); if(Array.isArray(d.savedRows)) savedRows=d.savedRows; }catch(e){} }

    function exportText(){ const blob=new Blob([savedRows.map(buildLineText).join('\n')],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='chiro-notes.txt'; a.click(); URL.revokeObjectURL(url); }
    function exportJSON(){ const blob=new Blob([JSON.stringify({savedRows},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='chiro-notes.json'; a.click(); URL.revokeObjectURL(url); }
    function importJSON(file){ const r=new FileReader(); r.onload=e=>{ try{ const data=JSON.parse(e.target.result); if(Array.isArray(data.savedRows)){ pushHistory({type:'import',prev:savedRows.slice()}); savedRows=data.savedRows; renderSaved(); persist(); } else alert('Invalid file (missing savedRows)'); }catch(err){ alert('Could not read file: '+err.message); } }; r.readAsText(file); }

    /* ==========================
       Custom adders (top of each column)
       ========================== */
    function wireCustomAdders(){
      document.querySelectorAll('[data-add-custom]').forEach(btnEl=>{
        btnEl.addEventListener('click',()=>{
          const key=btnEl.getAttribute('data-add-custom');
          const input=btnEl.previousElementSibling; const txt=(input.value||'').trim(); if(!txt) return; input.value='';
          const host=$('#'+(key==='listings'?'listings':key)); const d=btn(txt);
          host.prepend(d); // add at top
          if(key==='listings'){
            // listings is single-select
            $$('#listings .selected').forEach(x=>x.classList.remove('selected'));
            d.classList.add('selected'); selectedListings=[txt];
          } else if(key==='positions'){ d.addEventListener('click',()=>{ d.classList.toggle('selected'); selectedPositions=$$('#positions .selected').map(x=>x.textContent.trim()); badgeUpdate(); }); d.classList.add('selected'); selectedPositions.unshift(txt);
          } else if(key==='contacts'){ d.addEventListener('click',()=>{ d.classList.toggle('selected'); selectedContacts=$$('#contacts .selected').map(x=>x.textContent.trim()); badgeUpdate(); }); d.classList.add('selected'); selectedContacts.unshift(txt);
          } else if(key==='types'){ d.addEventListener('click',()=>{ d.classList.toggle('selected'); selectedTypes=$$('#types .selected').map(x=>x.textContent.trim()); badgeUpdate(); }); d.classList.add('selected'); selectedTypes.unshift(txt);
          } else if(key==='protocols' || key==='sot'){ d.addEventListener('click',()=>{ d.classList.toggle('selected'); badgeUpdate(); }); d.classList.add('selected'); }
          badgeUpdate();
        });
      });
    }

    /* ==========================
       SOAP helpers (optional focus)
       ========================== */
    let activeSoap='S';
    function wireSoap(){
      $$('.soap-header').forEach(h=>h.addEventListener('click',()=>{
        activeSoap=h.getAttribute('data-soap');
        $$('.soap-area').forEach(a=>a.classList.remove('active-section'));
        $('#soap-'+activeSoap).classList.add('active-section');
      }));
      $('#soap-S').classList.add('active-section');
    }

    /* ==========================
       Wiring
       ========================== */
    document.addEventListener('click',e=>{
      if(e.target.matches('#btn-add-row')) addRow();
      if(e.target.matches('#btn-clear-pending')) clearPending();
      if(e.target.matches('#btn-undo')) undo();
      if(e.target.matches('#btn-redo')) redo();
      if(e.target.matches('#btn-export-text')) exportText();
      if(e.target.matches('#btn-export-json')) exportJSON();
      if(e.target.matches('#btn-clear-all')){ savedRows=[]; undoStack=[]; redoStack=[]; persist(); renderSaved(); clearPending(); }
      if(e.target.closest('[data-del]')) delRow(parseInt(e.target.closest('[data-del]')?.getAttribute('data-del')));
      if(e.target.closest('[data-edit]')) loadRow(parseInt(e.target.closest('[data-edit]')?.getAttribute('data-edit')));
    });

    $('#import-json-input').addEventListener('change',e=>{ const f=e.target.files&&e.target.files[0]; if(f) importJSON(f); e.target.value=''; });

    // Init
    renderBones(); restore(); renderSaved(); wireCustomAdders(); wireSoap(); badgeUpdate();
    // Autosave safety net
    setInterval(persist, 5000);
  </script>
</body>
</html>
