<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive Chiropractic Listing Template - v2.10 (Phase 1+2, Objective column)</title>
  <style>
    :root { --ink:#2c5282; --ink2:#4a5568; --bg:#f4f7fa; --card:#fff; --line:#d1d9e6; --sel:#b3e6b3; --hover:#b3d4ff; --brand:#4a90e2; --brand2:#357abd; --focus:#7c3aed; }
    html,body{height:100%}
    body{margin:20px;font-family:'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:#333}
    h1{color:var(--ink);margin:0 0 14px}
    h3{color:var(--ink);margin:0 0 10px;text-align:center}
    h4{color:var(--ink2);margin:0 0 8px}

    .top-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
    .button{padding:8px 14px;background:var(--brand);color:#fff;border:0;border-radius:8px;cursor:pointer;font-size:14px;box-shadow:0 1px 2px rgba(0,0,0,.08)}
    .button:hover{background:var(--brand2)}

    .column-container{display:grid;grid-template-columns:1fr 1.2fr 0.9fr 1fr;gap:20px;align-items:start}
    .col{border:1px solid var(--line);background:var(--card);border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,.08);padding:14px;min-height:200px}
    .col-bones{grid-column:1}
    .col-listings{grid-column:2}
    .col-objective{grid-column:3}
    .col-soap{grid-column:4}

    .section{margin-bottom:16px}
    .section-header{cursor:pointer;font-weight:700;color:var(--ink);padding:10px 12px;background:#c7eaff;border:1px solid #b3c7f7;border-radius:10px;transition:.25s}
    .section-header:hover{background:#a8d1ff}

    .selectable,.selection-button{cursor:pointer;background:#e8f0fe;padding:8px;margin:6px 0;border:1px solid #b3c7f7;border-radius:8px;transition:.15s;position:relative;outline:none}
    .selectable:hover:not(.selected),.selection-button:hover:not(.selected){background:var(--hover)}
    .selection-button:focus{box-shadow:0 0 0 3px rgba(124,58,237,.35);border-color:var(--focus)}
    .selected{background:var(--sel)!important;border-color:#4caf50!important}
    .selected::after{content:"✓";position:absolute;right:8px;top:50%;transform:translateY(-50%);font-weight:700;color:#256029}
    .group{margin-bottom:10px}

    .rb-wrap{margin:16px 0;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .rb-bar{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;align-items:center}
    .rb-left{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .rb-badge{display:inline-flex;gap:6px;align-items:center;background:#e8f0fe;border:1px solid #b3c7f7;border-radius:999px;padding:6px 10px;font-size:13px;color:var(--ink)}
    .rb-actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn-sm{padding:6px 10px;font-size:13px;border-radius:8px;border:1px solid #cbd5e0;background:#f7fafc;cursor:pointer}
    .btn-sm.primary{background:var(--brand);border-color:var(--brand2);color:#fff}
    .btn-sm:disabled{opacity:.5;cursor:not-allowed}

    .saved-wrap{margin:16px 0;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .saved-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .saved-list{list-style:none;margin:0;padding:0}
    .saved-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:8px 10px;margin-bottom:6px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px}
    .icon-btn{border:1px solid #cbd5e0;background:#fff;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:12px}
    .icon-btn:hover{background:#edf2f7}
    .saved-text{font-size:14px;color:#2d3748}

    .custom-box{display:flex;gap:6px;margin-bottom:8px}
    .custom-box input{flex:1;padding:6px 8px;border:1px solid var(--line);border-radius:8px;font-size:13px}
    .custom-box button{padding:6px 10px;font-size:13px;border-radius:8px;border:1px solid #cbd5e0;background:#f7fafc;cursor:pointer}

    .soap-card{border:1px dashed var(--line);border-radius:12px;padding:10px}
    .soap-header{cursor:pointer;color:var(--ink);font-weight:700;margin:10px 0 6px}
    .soap-area{width:100%;height:120px;resize:vertical;border:1px solid var(--line);border-radius:8px;padding:8px;font-size:14px;box-sizing:border-box}
    .active-section{outline:2px solid #4caf50}

    .desktop-only-overlay{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,.8);color:#fff;z-index:5000;text-align:center;padding:24px}
    .desktop-only-overlay .card{background:#1a202c;padding:24px;border-radius:12px;max-width:520px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
    .desktop-only-overlay h2{margin:0 0 8px;font-size:22px}
    @media (max-width:1023px){.desktop-only-overlay{display:flex}.app-wrap{display:none!important}}
  </style>
</head>
<body>
  <div class="desktop-only-overlay"><div class="card"><h2>Desktop Only</h2><p>Please open this tool on a desktop or laptop (≥1024px wide).</p></div></div>

  <div class="app-wrap">
    <div class="top-buttons">
      <button id="btn-undo" class="button" title="Undo">Undo</button>
      <button id="btn-redo" class="button" title="Redo">Redo</button>
      <button id="btn-clear-all" class="button" title="Clear saved rows & selections">Clear All</button>
      <button id="btn-export-text" class="button" title="Export human‑readable text">Export .txt</button>
      <button id="btn-export-json" class="button" title="Export restorable JSON">Export .json</button>
      <label for="import-json-input" class="button" style="cursor:pointer">Import .json</label>
      <input id="import-json-input" type="file" accept="application/json" style="display:none" />
    </div>

    <h1>Interactive Chiropractic Listing Template</h1>

    <div class="rb-wrap" aria-live="polite">
      <div class="rb-bar">
        <div class="rb-left" id="rb-badges">
          <span class="rb-badge"><strong>Bone:</strong>&nbsp;<span data-rb="bone">—</span></span>
          <span class="rb-badge"><strong>Listing:</strong>&nbsp;<span data-rb="listing">—</span></span>
          <span class="rb-badge"><strong>Positions:</strong>&nbsp;<span data-rb="positions">—</span></span>
          <span class="rb-badge"><strong>Contacts:</strong>&nbsp;<span data-rb="contacts">—</span></span>
          <span class="rb-badge"><strong>Types:</strong>&nbsp;<span data-rb="types">—</span></span>
          <span class="rb-badge"><strong>Protocols:</strong>&nbsp;<span data-rb="protocols">—</span></span>
        </div>
        <div class="rb-actions">
          <button class="btn-sm" id="btn-clear-pending" title="Clear current selections">Clear</button>
          <button class="btn-sm primary" id="btn-add-row" disabled>Add Row</button>
        </div>
      </div>
    </div>

    <div class="saved-wrap">
      <div class="saved-header"><h4 style="margin:0;color:var(--ink)">Saved Entries</h4></div>
      <ul id="saved-list" class="saved-list"></ul>
    </div>

    <div class="column-container">
      <div class="col col-bones">
        <h3>Select Area / Category</h3>
        <div id="bones" role="listbox" aria-label="Areas and Bones"></div>
      </div>

      <div class="col col-listings">
        <h3>Listings & Adjustments</h3>
        <div class="section listings-section">
          <div class="custom-box"><input placeholder="Add custom listing…" aria-label="Add custom listing"><button type="button" data-add-custom="listings">Add</button></div>
          <h4>Listings</h4>
          <div id="listings" role="listbox" aria-label="Listings" aria-multiselectable="false"></div>
        </div>
        <div class="section positions-section">
          <div class="custom-box"><input placeholder="Add custom position…" aria-label="Add custom position"><button type="button" data-add-custom="positions">Add</button></div>
          <h4>Patient position</h4>
          <div id="positions" role="listbox" aria-label="Positions" aria-multiselectable="true"></div>
        </div>
        <div class="section contacts-section">
          <div class="custom-box"><input placeholder="Add custom contact…" aria-label="Add custom contact"><button type="button" data-add-custom="contacts">Add</button></div>
          <h4>Contact</h4>
          <div id="contacts" role="listbox" aria-label="Contacts" aria-multiselectable="true"></div>
        </div>
        <div class="section types-section">
          <div class="custom-box"><input placeholder="Add custom type…" aria-label="Add custom type"><button type="button" data-add-custom="types">Add</button></div>
          <h4>Type of adjustment</h4>
          <div id="types" role="listbox" aria-label="Types" aria-multiselectable="true"></div>
        </div>
        <div class="section protocols-section">
          <div class="custom-box"><input placeholder="Add custom protocol…" aria-label="Add custom protocol"><button type="button" data-add-custom="protocols">Add</button></div>
          <h4>Protocols</h4>
          <div id="protocols" role="listbox" aria-label="Protocols" aria-multiselectable="true"></div>
        </div>
      </div>

      <div class="col col-objective">
        <h3>Objective</h3>
        <div class="soap-card">
          <div class="soap-header" data-soap="O">OBJECTIVE FINDINGS</div>
          <textarea id="soap-O" class="soap-area" placeholder="Objective findings…" aria-label="Objective findings"></textarea>
        </div>
      </div>

      <div class="col col-soap">
        <h3>SOAP Notes</h3>
        <div class="soap-card">
          <div class="soap-header" data-soap="S">SUBJECTIVE</div>
          <textarea id="soap-S" class="soap-area" placeholder="Subjective notes…" aria-label="Subjective notes"></textarea>
          <div class="soap-header" data-soap="A">ACTION</div>
          <textarea id="soap-A" class="soap-area" placeholder="Actions performed…" aria-label="Actions performed"></textarea>
          <div class="soap-header" data-soap="P">PLAN</div>
          <textarea id="soap-P" class="soap-area" placeholder="Plan…" aria-label="Plan"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ========= Original data (unchanged except typo fixes) ========= */
    const listingsData = {
      'Cranial Bones': {
        commonListings: [
          { text: 'LEFT', tooltip: 'Left-sided adjustment' },
          { text: 'RIGHT', tooltip: 'Right-sided adjustment' },
          { text: 'Bilateral', tooltip: 'Both sides adjusted' },
          { text: 'Flexion', tooltip: 'Forward tilt adjustment' },
          { text: 'Extension', tooltip: 'Backward tilt adjustment' },
          { text: 'Inferior', tooltip: 'Downward adjustment' },
          { text: 'Superior', tooltip: 'Upward adjustment' }
        ],
        commonTypes: [
          { text: 'Neuro-Interlink Reflex', tooltip: 'Reflex-based correction' },
          { text: 'hold release', tooltip: 'Gentle hold and release technique for cranial sutures' },
          { text: 'finger toggle', tooltip: 'A gentle hold with torque followed by a HVLA thrust' },
          { text: 'CSF guided release', tooltip: 'Cerebrospinal fluid guided release technique' }
        ],
        commonProtocols: [
          { text: 'Howat 8 step Protocol', tooltip: 'Cranial detorque correction' },
          { text: 'Carter Nose correction protocol', tooltip: 'Nasal structure correction' },
          { text: 'Carter Sphenoid correction', tooltip: 'Protocol for sphenoid bone correction' }
        ],
        'Occipital': {
          positions: [
            { text: 'Occipito-mastoid suture', tooltip: 'Contact at occipito-mastoid junction' },
            { text: 'Lamboidal suture', tooltip: 'Contact at lamboidal suture' }
          ]
        },
        'Sphenoid': { positions: [ { text: 'Pterion' }, { text: 'Spheno-parietal Suture' }, { text: 'Spheno-frontal Suture' }, { text: 'Spheno-squamous Suture' }, { text: 'Spheno-zygomatic suture' } ] },
        'Maxilla': { positions: [ { text: 'Inter Maxillary Suture' }, { text: 'Median Palatine Suture' }, { text: 'Transverse Palatine suture' }, { text: 'Incisive suture' }, { text: 'Zygomatico-maxillary suture' }, { text: 'Lacrimo-maxillary suture' }, { text: 'Fronto maxillary suture' }, { text: 'Naso-maxillary suture' } ] },
        'Frontal': { positions: [ { text: 'Sagittal Suture' }, { text: 'Frontal Suture' }, { text: 'Frontonasal suture' }, { text: 'Fronto maxillary suture' }, { text: 'Fronto-lacrimal suture' }, { text: 'Fronto-zygomatic suture' }, { text: 'CCJ cranial detorque protocol' } ] },
        'Parietal': { positions: [ { text: 'Sagittal Suture' }, { text: 'Squamous Suture' }, { text: 'Spheno-parietal Suture' }, { text: 'Parietomastoid Suture' }, { text: 'Lamboidal suture' } ] },
        'Temporal': { positions: [ { text: 'Squamous Suture' }, { text: 'Temporo-zygomatic suture' }, { text: 'Spheno-squamous Suture' }, { text: 'Occipito-mastoid suture' }, { text: 'Parietomastoid Suture' }, { text: 'TMJ' } ] },
        'Zygomatic': { positions: [ { text: 'Temporo-zygomatic suture' }, { text: 'Spheno-zygomatic suture' }, { text: 'Zygomatico-maxillary suture' }, { text: 'Fronto-zygomatic suture' } ] },
        'Ethmoid': { positions: [ { text: 'Internasal suture' }, { text: 'Nose protocol' }, { text: 'Nasal cartilage' } ] },
        'Vomer': { positions: [ { text: 'Median Palatine Suture' }, { text: 'Gum release' } ] },
        'Mandible': { positions: [ { text: 'TMJ AI/PS' }, { text: 'Mentalis Suture' }, { text: 'Gum release' } ] }
      },
      'Cervical': {
        'Occiput': {
          listings: [ 'PS','PS-LS','PS-RS','AS','AS-LS','AS-RS','Left posterior Facet','Right posterior Facet','Bilateral posterior Facet' ].map(text=>({text})),
          positions: [ 'Prone','Supine','Seated','Side posture','Side Posture Toggle Recoil with drop' ].map(text=>({text})),
          types: [ 'Osseous','De-compression','Toggle Recoil','Finger toggle','Drop','Hold','Dural Breath' ].map(text=>({text}))
        },
        'C1/Atlas': {
          listings: [ 'ASR','ASR-P','ASR-A','PIR','PIR-P','PIR-A','ASL','ASL-P','ASL-A','PIL','PIL-P','PIL-A','Left posterior Facet','Right posterior Facet','Bilateral posterior Facet','Left anterior Facet','Right anterior Facet','Bilateral anterior Facet' ].map(text=>({text})),
          positions: [ 'Prone','Supine','Seated','Side posture' ].map(text=>({text})),
          contacts: [ 'TVP contact','Posterior arch contact' ].map(text=>({text})),
          types: [ 'Side Posture Toggle Recoil with drop','Osseous','Toggle Recoil','Finger toggle','Hold','Drop','Dural Breath','Coupled Motion','Lateral flexion','Rotation','De-compression','Pull','NUCCA' ].map(text=>({text}))
        },
        'C2-7': {
          listings: [ 'Left posterior Facet','Right posterior Facet','Bilateral posterior Facet','ASR-la','ASL-la','PR','PRS','PRI-la','PL','PLS','PLI-la','A2N','AL Disc','AR Disc','AL Facet','AR Facet' ].map(text=>({text})),
          positions: [ 'Prone','Supine','Seated','Side posture' ].map(text=>({text})),
          contacts: [ 'TVP contact','SP contact','Lamina contact','Articular pillar contact' ].map(text=>({text})),
          types: [ 'Osseous','Side Posture Toggle Recoil with drop','Drop','Toggle Recoil','Finger toggle','Hold','Dural Breath','Coupled Motion','Lateral flexion','Rotation','De-compression','Pull' ].map(text=>({text}))
        }
      },
      'Thoracic': {
        listings: [ 'Bilateral Facet','Left facet','Right facet','Left Rib','Right Rib','PR','PRS','PRI-t','PL','PLS','PLI-t','Left side slip','Right side slip','Anterior','AR','ARS','ARI-t','AL','ALI-t','Anterior Rib Cartilage','Left posterior Facet','Right posterior Facet','Bilateral posterior Facet' ].map(text=>({text})),
        positions: [ 'Prone','Supine','Standing','Seated' ].map(text=>({text})),
        contacts: [ 'X Bilateral','Double thenar','Unilateral Reinforced','TVP contact','SP contact','Thumb Contact','Double Finger Reinforced','ABC roll','Anterior Thoracic' ].map(text=>({text})),
        types: [ 'Osseous','Drop','Finger Toggle','Hold','Dural Breath','Inhalation','Expiration' ].map(text=>({text}))
      },
      'Lumbar': {
        listings: [ 'Left posterior Facet','Right posterior Facet','PR','PRS','PRI-m','PL','PLS','PLI-m','Anterior' ].map(text=>({text})),
        positions: [ 'Side posture','Prone','Supine','Standing' ].map(text=>({text})),
        contacts: [ 'SP contact','Mammillary contact' ].map(text=>({text})),
        types: [ 'Osseous','Push move','Pull move','Coupled Motion','ISU','ISD','Drop','Finger Toggle','Hold','Dural Breath','ABC roll' ].map(text=>({text}))
      },
      'Pelvis': {
        listings: [ 'PI','PIIn','PIEx','AS','ASIn','ASEx','Ex','In','Ex/In','In/Ex' ].map(text=>({text})),
        positions: [ 'Side posture','Prone','Supine','Standing' ].map(text=>({text})),
        types: [ 'Osseous','Drop','Blocked','Finger toggle','Hold','Dural Breath','Push move','Pull move','Pump' ].map(text=>({text}))
      },
      'Sacrum & coccyx': {
        listings: [ 'P','P-L','P-R','P-L inf','P-R inf','L-inf','R-inf','A-L','A-R','A-L-inf','A-R-inf' ].map(text=>({text})),
        positions: [ 'Side posture','Prone','Supine' ].map(text=>({text})),
        types: [ 'Osseous','ISU','ISD','Push move','Pull move','Drop','Finger Toggle','Hold','Dural Breath','Logan Basic L','Logan Basic R' ].map(text=>({text}))
      },
      'Extremities': {
        listings: [ 'LEFT','RIGHT','BILATERAL','TMJ','Shoulder','Elbow','Wrist','Hand','Hip','Knee','Ankle','Foot' ].map(text=>({text})),
        positions: [ 'Supine','Seated','Standing','Prone','Side posture' ].map(text=>({text})),
        contacts: [ 'Medial','Intermediate','Lateral' ].map(text=>({text})),
        types: [ 'Osseous','Drop','Stimulation' ].map(text=>({text}))
      }
    };

    /* ===== State ===== */
    let selectedBone = '';
    let selectedCategory = '';
    let selectedListings = [];
    let selectedPositions = [];
    let selectedContacts = [];
    let selectedTypes = [];
    let selectedProtocols = [];

    let savedRows = [];
    let editingIndex = null;
    let undoStack = [];
    let redoStack = [];

    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const btn = (t, cls='selection-button')=>{ const d=document.createElement('div'); d.className=cls; d.textContent=t; d.setAttribute('tabindex','0'); d.setAttribute('role','option'); d.setAttribute('aria-selected','false'); return d; };

    function setSel(el, yes){ el.classList.toggle('selected', !!yes); el.setAttribute('aria-selected', yes? 'true':'false'); }

    function badgeUpdate(){
      const set=(k,v)=>{ const el=$(`[data-rb="${k}"]`); if(!el) return; if(Array.isArray(v)) el.textContent=v.length? v.join(', '):'—'; else el.textContent=v||'—'; };
      set('bone', selectedBone);
      set('listing', selectedListings[0]||'—');
      set('positions', selectedPositions);
      set('contacts', selectedContacts);
      set('types', selectedTypes);
      set('protocols', selectedProtocols);
      $('#btn-add-row')?.toggleAttribute('disabled', !(selectedBone && selectedListings.length));
    }

    function clearPending(){
      selectedBone=''; selectedCategory='';
      selectedListings=[]; selectedPositions=[]; selectedContacts=[]; selectedTypes=[]; selectedProtocols=[];
      $$('.selected').forEach(x=>setSel(x,false));
      ['listings','positions','contacts','types','protocols'].forEach(id=>$('#'+id).innerHTML='');
      badgeUpdate();
      const b=$('#btn-add-row'); if(b) b.textContent='Add Row';
    }

    function renderBones(){
      const host=$('#bones'); host.innerHTML='';
      Object.keys(listingsData).forEach(sectionName=>{
        const section=listingsData[sectionName];
        const wrap=document.createElement('div'); wrap.className='group';
        const hdr=document.createElement('div'); hdr.className='section-header'; hdr.textContent=sectionName; wrap.appendChild(hdr);
        const inner=document.createElement('div'); inner.style.marginTop='8px'; wrap.appendChild(inner);

        const subKeys=Object.keys(section).filter(k=>!['commonListings','commonTypes','commonProtocols','listings','positions','contacts','types','protocols'].includes(k));
        if(subKeys.length && typeof section[subKeys[0]] === 'object' && !Array.isArray(section[subKeys[0]]) ){
          subKeys.forEach(sub=>{
            const b=btn(sub,'selectable');
            b.addEventListener('click',()=>{ $$('#bones .selected').forEach(x=>setSel(x,false)); setSel(b,true); selectedBone=sub; selectedCategory=sectionName; badgeUpdate(); renderRightPanelFor(sectionName, sub); });
            b.addEventListener('keydown', (e)=>handleOptionKeys(e, ()=>b.click(), inner));
            inner.appendChild(b);
          });
        } else {
          const b=btn(sectionName,'selectable');
          b.addEventListener('click',()=>{ $$('#bones .selected').forEach(x=>setSel(x,false)); setSel(b,true); selectedBone=sectionName; selectedCategory=sectionName; badgeUpdate(); renderRightPanelFor(sectionName, null); });
          b.addEventListener('keydown', (e)=>handleOptionKeys(e, ()=>b.click(), inner));
          inner.appendChild(b);
        }
        host.appendChild(wrap);
      });
    }

    function renderRightPanelFor(sectionName, sub){
      selectedListings=[]; selectedPositions=[]; selectedContacts=[]; selectedTypes=[]; selectedProtocols=[];
      ['listings','positions','contacts','types','protocols'].forEach(id=>$('#'+id).innerHTML='');

      const section=listingsData[sectionName];
      const block=sub? section[sub] : section;

      // Listings (single-select)
      const listingsHost=$('#listings');
      const listings=(block && block.listings) || (section.commonListings) || [];
      listings.forEach(it=>{
        const text=(it.text||it);
        const d=btn(text);
        d.addEventListener('click',()=>{
          $$('#listings .selected').forEach(x=>setSel(x,false));
          if(!d.classList.contains('selected')){ setSel(d,true); selectedListings=[text]; } else { selectedListings=[]; }
          badgeUpdate();
        });
        d.addEventListener('keydown', (e)=>handleOptionKeys(e, ()=>d.click(), listingsHost));
        listingsHost.appendChild(d);
      });

      // Positions (multi)
      const positionsHost=$('#positions');
      const positions=(block && block.positions) || [];
      positions.forEach(it=>{
        const text=(it.text||it); const d=btn(text);
        d.addEventListener('click',()=>{ setSel(d,!d.classList.contains('selected')); selectedPositions=$$('#positions .selected').map(x=>x.textContent.trim()); badgeUpdate(); });
        d.addEventListener('keydown', (e)=>handleOptionKeys(e, ()=>d.click(), positionsHost));
        positionsHost.appendChild(d);
      });

      // Contacts (multi)
      const contactsHost=$('#contacts');
      const contacts=(block && block.contacts) || [];
      contacts.forEach(it=>{
        const text=(it.text||it); const d=btn(text);
        d.addEventListener('click',()=>{ setSel(d,!d.classList.contains('selected')); selectedContacts=$$('#contacts .selected').map(x=>x.textContent.trim()); badgeUpdate(); });
        d.addEventListener('keydown', (e)=>handleOptionKeys(e, ()=>d.click(), contactsHost));
        contactsHost.appendChild(d);
      });

      // Types (multi)
      const typesHost=$('#types');
      const types=(block && block.types) || (section.commonTypes) || [];
      types.forEach(it=>{
        const text=(it.text||it); const d=btn(text);
        d.addEventListener('click',()=>{ setSel(d,!d.classList.contains('selected')); selectedTypes=$$('#types .selected').map(x=>x.textContent.trim()); badgeUpdate(); });
        d.addEventListener('keydown', (e)=>handleOptionKeys(e, ()=>d.click(), typesHost));
        typesHost.appendChild(d);
      });

      // Protocols (multi)
      const protocolsHost=$('#protocols');
      const protocols=(block && block.protocols) || (section.commonProtocols) || [];
      protocols.forEach(it=>{
        const text=(it.text||it); const d=btn(text);
        d.addEventListener('click',()=>{ setSel(d,!d.classList.contains('selected')); selectedProtocols=$$('#protocols .selected').map(x=>x.textContent.trim()); badgeUpdate(); });
        d.addEventListener('keydown', (e)=>handleOptionKeys(e, ()=>d.click(), protocolsHost));
        protocolsHost.appendChild(d);
      });

      badgeUpdate();
    }

    // Keyboard handling for options
    function handleOptionKeys(e, onActivate, container){
      const key=e.key; const target=e.target.closest('[role="option"]'); if(!target) return;
      const items=$$('[role="option"]', container);
      const idx=items.indexOf(target);
      if(key==='Enter' || key===' '){ e.preventDefault(); onActivate(); return; }
      if(key==='ArrowDown'){ e.preventDefault(); (items[idx+1]||items[0])?.focus(); return; }
      if(key==='ArrowUp'){ e.preventDefault(); (items[idx-1]||items[items.length-1])?.focus(); return; }
      if(key==='Escape'){ target.blur(); return; }
    }

    function buildLineText(row){
      const j=a=>a&&a.length? a.join(', '):null;
      return [row.bone,row.listing,j(row.positions),j(row.contacts),j(row.types),j(row.protocols)].filter(Boolean).join(' — ');
    }

    function renderSaved(){
      const ul=$('#saved-list'); ul.innerHTML='';
      savedRows.forEach((row,idx)=>{
        const li=document.createElement('li'); li.className='saved-item';
        li.innerHTML=`<div class="saved-text">${buildLineText(row)}</div>
          <div>
            <button class="icon-btn" data-edit="${idx}" aria-label="Edit row ${idx+1}">✎ Edit</button>
            <button class="icon-btn" data-del="${idx}" aria-label="Delete row ${idx+1}">🗑️ Delete</button>
          </div>`;
        ul.appendChild(li);
      });
    }

    function pushHistory(action){ undoStack.push(action); redoStack=[]; }

    function addRow(){
      if(!(selectedBone && selectedListings.length)) return;
      const row={ id:crypto.randomUUID?crypto.randomUUID():String(Date.now()+Math.random()), bone:selectedBone, listing:selectedListings[0], positions:selectedPositions.slice(0), contacts:selectedContacts.slice(0), types:selectedTypes.slice(0), protocols:selectedProtocols.slice(0) };
      if(editingIndex!==null){ const prev={...savedRows[editingIndex]}; savedRows[editingIndex]=row; pushHistory({type:'edit',index:editingIndex,prev,next:{...row}}); editingIndex=null; $('#btn-add-row').textContent='Add Row'; }
      else { savedRows.push(row); pushHistory({type:'add',index:savedRows.length-1,row:{...row}}); }
      persist(); renderSaved(); clearPending();
    }

    function delRow(idx){ const [removed]=savedRows.splice(idx,1); pushHistory({type:'delete',index:idx,row:removed}); persist(); renderSaved(); }

    function loadRow(idx){
      const row=savedRows[idx]; if(!row) return; clearPending();
      let secName=null; Object.keys(listingsData).forEach(name=>{ if(listingsData[name][row.bone]) secName=name; }); if(!secName && listingsData[row.bone]) secName=row.bone; if(!secName) secName = selectedCategory || Object.keys(listingsData)[0];
      selectedCategory=secName; selectedBone=row.bone;
      $$('#bones .selectable').forEach(el=>{ if(el.textContent.trim()===row.bone || el.textContent.trim()===secName && secName===row.bone) setSel(el,true); else setSel(el,false); });
      renderRightPanelFor(secName, listingsData[secName][row.bone] ? row.bone : null);
      function selectIn(hostId, values){ values.forEach(v=>{ $(`#${hostId}`)?.querySelectorAll('.selection-button')?.forEach(el=>{ if(el.textContent.trim()===v) setSel(el,true); }); }); }
      selectedListings=[row.listing]; selectIn('listings',[row.listing]);
      selectedPositions=row.positions||[]; selectIn('positions',selectedPositions);
      selectedContacts=row.contacts||[]; selectIn('contacts',selectedContacts);
      selectedTypes=row.types||[]; selectIn('types',selectedTypes);
      selectedProtocols=row.protocols||[]; selectIn('protocols',selectedProtocols);
      editingIndex=idx; badgeUpdate(); $('#btn-add-row').textContent='Save Changes';
    }

    function undo(){ const a=undoStack.pop(); if(!a) return; switch(a.type){ case 'add': savedRows.splice(a.index,1); redoStack.push(a); break; case 'edit': savedRows[a.index]=a.prev; redoStack.push(a); break; case 'delete': savedRows.splice(a.index,0,a.row); redoStack.push(a); break; case 'import': savedRows=a.prev; redoStack.push(a); break; } persist(); renderSaved(); }
    function redo(){ const a=redoStack.pop(); if(!a) return; switch(a.type){ case 'add': savedRows.splice(a.index,0,a.row); break; case 'edit': savedRows[a.index]=a.next; break; case 'delete': savedRows.splice(a.index,1); break; case 'import': break; } undoStack.push(a); persist(); renderSaved(); }

    function persist(){ try{ localStorage.setItem('chiroNotes_phase1', JSON.stringify({savedRows})); }catch(e){} }
    function restore(){ try{ const raw=localStorage.getItem('chiroNotes_phase1'); if(!raw) return; const d=JSON.parse(raw); if(Array.isArray(d.savedRows)) savedRows=d.savedRows; }catch(e){} }

    function exportText(){ const blob=new Blob([savedRows.map(buildLineText).join('\n')],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='chiro-notes.txt'; a.click(); URL.revokeObjectURL(url); }
    function exportJSON(){ const blob=new Blob([JSON.stringify({savedRows},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='chiro-notes.json'; a.click(); URL.revokeObjectURL(url); }
    function importJSON(file){ const r=new FileReader(); r.onload=e=>{ try{ const data=JSON.parse(e.target.result); if(Array.isArray(data.savedRows)){ pushHistory({type:'import',prev:savedRows.slice()}); savedRows=data.savedRows; renderSaved(); persist(); } else alert('Invalid file (missing savedRows)'); }catch(err){ alert('Could not read file: '+err.message); } }; r.readAsText(file); }

    function wireCustomAdders(){
      document.querySelectorAll('[data-add-custom]').forEach(btnEl=>{
        btnEl.addEventListener('click',()=>{
          const key=btnEl.getAttribute('data-add-custom');
          const input=btnEl.previousElementSibling; const txt=(input.value||'').trim(); if(!txt) return; input.value='';
          const host=$('#'+(key==='listings'?'listings':key)); const d=btn(txt);
          host.prepend(d);
          if(key==='listings'){ $$('#listings .selected').forEach(x=>setSel(x,false)); setSel(d,true); selectedListings=[txt]; }
          else if(key==='positions'){ d.addEventListener('click',()=>{ setSel(d,!d.classList.contains('selected')); selectedPositions=$$('#positions .selected').map(x=>x.textContent.trim()); badgeUpdate(); }); setSel(d,true); selectedPositions.unshift(txt); }
          else if(key==='contacts'){ d.addEventListener('click',()=>{ setSel(d,!d.classList.contains('selected')); selectedContacts=$$('#contacts .selected').map(x=>x.textContent.trim()); badgeUpdate(); }); setSel(d,true); selectedContacts.unshift(txt); }
          else if(key==='types'){ d.addEventListener('click',()=>{ setSel(d,!d.classList.contains('selected')); selectedTypes=$$('#types .selected').map(x=>x.textContent.trim()); badgeUpdate(); }); setSel(d,true); selectedTypes.unshift(txt); }
          else if(key==='protocols'){ d.addEventListener('click',()=>{ setSel(d,!d.classList.contains('selected')); selectedProtocols=$$('#protocols .selected').map(x=>x.textContent.trim()); badgeUpdate(); }); setSel(d,true); selectedProtocols.unshift(txt); }
          d.addEventListener('keydown', (e)=>handleOptionKeys(e, ()=>d.click(), host));
          badgeUpdate();
        });
      });
    }

    let activeSoap='S';
    function wireSoap(){
      $$('.soap-header').forEach(h=>h.addEventListener('click',()=>{ activeSoap=h.getAttribute('data-soap'); $$('.soap-area').forEach(a=>a.classList.remove('active-section')); $('#soap-'+activeSoap).classList.add('active-section'); }));
      $('#soap-S').classList.add('active-section');
    }

    document.addEventListener('click',e=>{
      if(e.target.matches('#btn-add-row')) addRow();
      if(e.target.matches('#btn-clear-pending')) clearPending();
      if(e.target.matches('#btn-undo')) undo();
      if(e.target.matches('#btn-redo')) redo();
      if(e.target.matches('#btn-export-text')) exportText();
      if(e.target.matches('#btn-export-json')) exportJSON();
      if(e.target.matches('#btn-clear-all')){ savedRows=[]; undoStack=[]; redoStack=[]; persist(); renderSaved(); clearPending(); }
      if(e.target.closest('[data-del]')) delRow(parseInt(e.target.closest('[data-del]')?.getAttribute('data-del')));
      if(e.target.closest('[data-edit]')) loadRow(parseInt(e.target.closest('[data-edit]')?.getAttribute('data-edit')));
    });

    document.getElementById('import-json-input').addEventListener('change',e=>{ const f=e.target.files&&e.target.files[0]; if(f) importJSON(f); e.target.value=''; });

    renderBones(); restore(); renderSaved(); wireCustomAdders(); wireSoap(); badgeUpdate();
    setInterval(persist, 5000);
  </script>
</body>
</html>


