<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive Chiropractic Listing Template — v2.12</title>
  <style>
    :root {
      --ink:#2c5282; --ink2:#4a5568; --bg:#f4f7fa; --card:#fff; --line:#d1d9e6; --brand:#4a90e2; --brand2:#357abd;
    }
    html,body{height:100%}
    body { margin:20px; font-family:"Helvetica Neue", Arial, sans-serif; background:var(--bg); color:#333; }

    .top-buttons{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px}
    .button{padding:8px 14px; background:var(--brand); color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:14px; box-shadow:0 1px 2px rgba(0,0,0,.1)}
    .button:hover{background:var(--brand2)}
    .button.selected{background:#2fbf71}

    h1{color:var(--ink); margin-bottom:14px}
    h3{color:var(--ink); margin:10px 0}
    h4{color:var(--ink2); margin:8px 0}

    .column-container{display:grid; grid-template-columns: 1fr 1.2fr .9fr; gap:20px; align-items:start}
    .col{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow:0 2px 4px rgba(0,0,0,.06)}

    /* Objective column headers */
    .section-header{padding:10px 12px; background:#e3f2fd; color:#2c5282; border:1px solid #b3c7f7; border-radius:8px; cursor:pointer; margin:10px 0; transition:.2s}
    .section-header:hover{background:#cfe8ff}

    /* Modal */
    .modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000}
    .modal-content{background:#fff; width:min(960px,92vw); max-height:90vh; overflow:auto; margin:5vh auto; padding:20px; border-radius:12px; border:1px solid #888; box-shadow:0 8px 24px rgba(0,0,0,.2)}
    .close{float:right; font-size:28px; cursor:pointer; color:#666}
    .close:hover{color:#000}

    /* Table styles (original look) */
    .attractive-table{width:100%; border-collapse:separate; border-spacing:0 8px}
    .attractive-table th, .attractive-table td{padding:8px 12px; vertical-align:middle; text-align:left}
    .attractive-table th{background:#81d4fa; color:#01579b; border-top-left-radius:6px; border-bottom-left-radius:6px; font-size:14px; width:35%}
    .attractive-table td{background:#e1f5fe; border-top-right-radius:6px; border-bottom-right-radius:6px}
    .attractive-table .button-group{display:flex; gap:6px; flex-wrap:wrap}

    .neuro-table{width:100%; border-collapse:collapse; margin:12px 0 20px}
    .neuro-table th, .neuro-table td{border:1px solid #d1d9e6; padding:8px; text-align:center}
    .neuro-table th{background:#2c5282; color:#fff}

    .number-selector-table{width:100%; margin:10px 0 16px}
    .number-selector-table caption{font-weight:bold; color:#2c5282; margin-bottom:8px}
    .number-selector-table td{padding:5px; text-align:center}

    .vip-section{margin:6px 0 18px}
    .vip-section .text-input-group{display:flex; gap:8px}
    .vip-section input{flex:1; padding:8px; border:1px solid #b3c7f7; border-radius:6px}

    /* Sub-modal (for advanced pickers) */
    .sub-modal{display:none; position:fixed; inset:0; z-index:2000; background:rgba(0,0,0,.45)}
    .sub-modal .sub-modal-content{background:#fff; width:min(900px,92vw); margin:6vh auto; padding:20px; border-radius:12px; border:1px solid #888; max-height:88vh; overflow:auto}

    /* Small selection grid used inside sub-modal */
    .selection-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(60px,1fr)); gap:6px}
    .selection-button{padding:8px; background:#e8f0fe; border:1px solid #b3c7f7; border-radius:6px; cursor:pointer; text-align:center}
    .selection-button.selected{background:#b3e6b3; border-color:#2fbf71}

    .gyro-container{display:flex; flex-direction:column; gap:16px}
    .gyro-line-row{display:flex; gap:36px; justify-content:space-between}
    .gyro-side{flex:1}
    .gyro-buttons{display:flex; gap:8px; flex-wrap:wrap}

    /* Desktop-only overlay */
    #desktopOnly{display:none; position:fixed; inset:0; background:#fff; z-index:3000; align-items:center; justify-content:center; text-align:center; padding:24px}
    #desktopOnly h2{margin-bottom:8px}

    textarea{width:100%; min-height:110px; border:1px solid var(--line); border-radius:8px; padding:10px; resize:vertical}
  </style>
</head>
<body>
  <!-- Desktop-only gate -->
  <div id="desktopOnly"><div><h2>Desktop only</h2><p>Please open this tool on a desktop or widen your window.</p></div></div>

  <div class="top-buttons">
    <button class="button" onclick="undo()">Undo</button>
    <button class="button" onclick="redo()">Redo</button>
    <button class="button" onclick="clearAll()">Clear All</button>
    <button class="button" onclick="exportData()">Save & Export Data</button>
  </div>

  <h1>Interactive Chiropractic Listing Template</h1>

  <div class="column-container">
    <!-- Column 1: Objective Findings -->
    <div class="col">
      <h3>Objective Findings</h3>
      <div id="objectiveContent"></div>
    </div>

    <!-- Column 2: Area/Category (kept minimal here; your existing dataset can plug in) -->
    <div class="col">
      <h3>Select Area / Category</h3>
      <div class="selectable" onclick="selectCategory('Cranial Bones', this)">Cranial Bones</div>
      <div class="selectable" onclick="selectCategory('Cervical', this)">Cervical</div>
      <div class="selectable" onclick="selectCategory('Thoracic', this)">Thoracic</div>
      <div class="selectable" onclick="selectCategory('Lumbar', this)">Lumbar</div>
      <div class="selectable" onclick="selectCategory('Pelvis', this)">Pelvis</div>
      <div class="selectable" onclick="selectCategory('Sacrum & coccyx', this)">Sacrum & coccyx</div>
      <div class="selectable" onclick="selectCategory('Extremities', this)">Extremities</div>
      <div class="selectable" onclick="selectCategory('Zones', this)">Zones</div>
      <div id="colBonesContent"></div>

      <details id="listingsDetails" style="margin-top:10px">
        <summary>Listings</summary>
        <div id="listingsContainer"></div>
      </details>
      <details id="positionsDetails">
        <summary>Patient position</summary>
        <div id="positionsContainer"></div>
      </details>
      <details id="contactsDetails" style="display:none">
        <summary>Contact</summary>
        <div id="contactsContainer"></div>
      </details>
      <details id="typesDetails">
        <summary>Type of adjustment</summary>
        <div id="typesContainer"></div>
      </details>
      <details id="protocolsDetails" style="display:none">
        <summary>Cranial protocols</summary>
        <div id="protocolsContainer"></div>
      </details>
      <details id="sotDetails" style="display:none">
        <summary>SOT</summary>
        <div id="sotContainer"></div>
      </details>
      <button id="addToSoapButton" class="button" onclick="addToSoap()" style="display:none; margin-top:10px">Add to SOAP</button>
      <div style="margin-top:12px">
        <label>Custom Action: <input id="customActionInput" type="text" onkeydown="if(event.key==='Enter') addCustomToAction()" style="padding:6px; border:1px solid #b3c7f7; border-radius:6px" /></label>
        <button class="button" onclick="addCustomToAction()">Add to Action</button>
      </div>
    </div>

    <!-- Column 3: SOAP notes -->
    <div class="col">
      <h3>SOAP Notes</h3>
      <div id="subjectiveSection" class="soap-section">
        <h4 class="soap-header" onclick="setActiveSection('subjective')">SUBJECTIVE</h4>
        <textarea id="subjectiveField"></textarea>
      </div>
      <div id="objectiveSection" class="soap-section">
        <h4 class="soap-header" onclick="setActiveSection('objective')">OBJECTIVE FINDINGS</h4>
        <textarea id="objectiveField"></textarea>
      </div>
      <div id="actionSection" class="soap-section">
        <h4 class="soap-header" onclick="setActiveSection('action')">ACTION</h4>
        <textarea id="actionField"></textarea>
      </div>
      <div id="planSection" class="soap-section">
        <h4 class="soap-header" onclick="setActiveSection('plan')">PLAN</h4>
        <textarea id="planField"></textarea>
        <div>
          <label>Exercise: <input id="planExercise" type="text" /></label>
          <button class="button" onclick="addPlanExercise()">Add</button>
        </div>
        <div>
          <label>Nutrition: <input id="planNutrition" type="text" /></label>
          <button class="button" onclick="addPlanNutrition()">Add</button>
        </div>
        <div>
          <label>Check next visit: <input id="planCheck" type="text" /></label>
          <button class="button" onclick="addPlanCheck()">Add</button>
        </div>
      </div>
      <p id="status" style="color:#4a5568; font-size:12px">(Click a SOAP header to set it active; new entries insert at the cursor.)</p>
    </div>
  </div>

  <!-- Sub-modal for advanced pickers (Gyro / Zones / VIP tree) -->
  <div id="subModal" class="sub-modal" aria-hidden="true">
    <div class="sub-modal-content">
      <span class="close" onclick="closeCurrentModal()">&times;</span>
      <h3 id="subModalTitle"></h3>
      <div id="selectionGrid" class="selection-grid"></div>
      <div id="subExtras"></div>
      <button class="button" style="margin-top:12px" onclick="addSelectionsFromSubModal()">Add to SOAP note</button>
    </div>
  </div>

  <!-- Main modal (Objective column) -->
  <div id="objectiveModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal(objectiveModal)">&times;</span>
      <h3 id="modalTitle"></h3>
      <div id="modalContentDiv"></div>
    </div>
  </div>

  <script>
    // Simple state + autosave
    let activeTextarea = null; // 'subjective' | 'objective' | 'action' | 'plan'
    let history = []; let future = [];

    function getData(){ return { subjective:subjectiveField.value, objective:objectiveField.value, action:actionField.value, plan:planField.value }; }
    function setData(d){ subjectiveField.value=d.subjective||''; objectiveField.value=d.objective||''; actionField.value=d.action||''; planField.value=d.plan||''; }
    function saveData(){ localStorage.setItem('chiroData', JSON.stringify(getData())); }

    function saveSnapshot(isUndoRedo=false){ const d=getData(); history.push(JSON.parse(JSON.stringify(d))); if(history.length>30) history.shift(); if(!isUndoRedo) future=[]; }
    function undo(){ if(history.length>1){ const cur=history.pop(); future.push(cur); setData(history[history.length-1]); saveData(); } }
    function redo(){ if(future.length){ const nxt=future.pop(); history.push(nxt); setData(nxt); saveData(); } }

    function clearAll(){ if(confirm('Clear all text areas?')){ subjectiveField.value=objectiveField.value=actionField.value=planField.value=''; saveData(); saveSnapshot(true);} }
    function exportData(){ const dataStr='data:text/plain;charset=utf-8,'+encodeURIComponent(JSON.stringify(getData(),null,2)); const a=document.createElement('a'); a.href=dataStr; a.download='soap_notes.txt'; a.click(); }

    // Cursor-aware insertion
    function setActiveSection(which){ activeTextarea=which; document.querySelectorAll('.soap-header').forEach(h=>h.style.textDecoration=''); event?.currentTarget && (event.currentTarget.style.textDecoration='underline'); }
    function insertAtCursor(el, text){ const start=el.selectionStart || el.value.length; const end=el.selectionEnd || el.value.length; const before=el.value.slice(0,start); const after=el.value.slice(end); const spacer = (before && !before.endsWith('\n'))?'\n':''; el.value = before + spacer + text + '\n' + after; el.focus(); el.selectionStart=el.selectionEnd=(before+spacer+text+'\n').length; }

    function addToObjective(text){ const el = document.getElementById('objectiveField'); insertAtCursor(el, text); saveData(); flashStatus(); }
    function addToAction(text){ const el = document.getElementById('actionField'); insertAtCursor(el, text); saveData(); flashStatus(); }

    function flashStatus(){ status.textContent='Saved.'; setTimeout(()=>status.textContent='Ready. Data auto-saves.', 800); }

    // ===== Objective Column: sections =====
    function openModal(title, content){ modalTitle.textContent=title; modalContentDiv.innerHTML=''; modalContentDiv.appendChild(content); objectiveModal.style.display='block'; }
    function closeModal(m){ m.style.display='none'; }
    window.addEventListener('click', (e)=>{ if(e.target===objectiveModal) closeModal(objectiveModal); if(e.target===subModal) closeCurrentModal(); });

    // Palpatory Findings (table formatting)
    function generatePalpatoryFindingsContent(){
      const table=document.createElement('table'); table.className='attractive-table';
      const groups=[
        { title:'RCPM tight and tender', buttons:[{text:'Left', value:'RCPM tight and tender Left'},{text:'Right', value:'RCPM tight and tender Right'}]},
        { title:'GSC (Gyroscopic Subluxation Complex)', buttons:[{text:'Left', value:'GSC Left'},{text:'Right', value:'GSC Right'}]},
        { title:'Great Toe Extension Loss', buttons:[{text:'Left', value:'Great Toe Extension Loss Left'},{text:'Right', value:'Great Toe Extension Loss Right'}]},
        { title:'Short leg', buttons:[{text:'Left', value:'Short leg Left'},{text:'Right', value:'Short leg Right'}]},
        { title:'Derifield', buttons:[{text:'-ve', value:'Derifield -ve'},{text:'+ve', value:'Derifield +ve'}]},
        { title:'Prone H2B ROM decreased', buttons:[{text:'Left', value:'Prone H2B ROM decreased Left'},{text:'Right', value:'Prone H2B ROM decreased Right'}]},
        { title:'Meningeal Torque', buttons:[{text:'Diaschisis', value:'Predominant Meningeal Torque Diaschisis'},{text:'Necrotic', value:'Meningeal Torque Necrotic'}]},
      ];
      groups.forEach(g=>{ const tr=document.createElement('tr'); const th=document.createElement('th'); th.textContent=g.title; tr.appendChild(th); const td=document.createElement('td'); const wrap=document.createElement('div'); wrap.className='button-group'; g.buttons.forEach(b=>{ const btn=document.createElement('button'); btn.className='button'; btn.textContent=b.text; btn.onclick=()=>addToObjective(b.value); wrap.appendChild(btn); }); td.appendChild(wrap); tr.appendChild(td); table.appendChild(tr); });
      return table;
    }

    function createPalpatoryFindingsHeader(parent){ const header=document.createElement('div'); header.className='section-header'; header.textContent='Palpatory Findings'; header.onclick=()=>openModal('Palpatory Findings', generatePalpatoryFindingsContent()); parent.appendChild(header); }

    // System Fault Lines — restored to table-like layout
    function createCombinedNeuroGrid(parent){
      const table=document.createElement('table'); table.className='neuro-table';
      const thead=document.createElement('thead'); const tr=document.createElement('tr');
      const thItem=document.createElement('th'); thItem.textContent='Item'; tr.appendChild(thItem);
      ['Left','Right','Bilateral'].forEach(side=>{ const th=document.createElement('th'); th.textContent=side; tr.appendChild(th); });
      thead.appendChild(tr); table.appendChild(thead);
      const tbody=document.createElement('tbody');
      const items=[1,2,3,4,5,6,7,'2/1','2/2','2/3'];
      items.forEach(item=>{ const row=document.createElement('tr'); const tdItem=document.createElement('td'); tdItem.textContent=item; row.appendChild(tdItem); ['Left','Right','Bilateral'].forEach(side=>{ const td=document.createElement('td'); const btn=document.createElement('button'); btn.className='button'; btn.textContent=side; btn.onclick=()=>addToObjective(`Neurological Gyroscope: ${item} ${side}`); td.appendChild(btn); row.appendChild(td); }); tbody.appendChild(row); });
      table.appendChild(tbody); parent.appendChild(table);
    }

    function createNumberSelector(parent, title, items=[1,2,3,4,5,6,7]){
      const table=document.createElement('table'); table.className='number-selector-table';
      const cap=document.createElement('caption'); cap.textContent=title; table.appendChild(cap);
      const tr=document.createElement('tr'); items.forEach(n=>{ const td=document.createElement('td'); const btn=document.createElement('button'); btn.className='button'; btn.textContent=n; btn.onclick=()=>addToObjective(`${title}: ${n}`); td.appendChild(btn); tr.appendChild(td); }); table.appendChild(tr); parent.appendChild(table);
    }

    function createTextInputSection(parent, title){ const box=document.createElement('div'); box.className='vip-section'; const h=document.createElement('h4'); h.textContent=title; box.appendChild(h); const row=document.createElement('div'); row.className='text-input-group'; const input=document.createElement('input'); input.placeholder='e.g. Stomach (cardiac)'; input.addEventListener('keypress', e=>{ if(e.key==='Enter'){ add(); }}); row.appendChild(input); const btn=document.createElement('button'); btn.className='button'; btn.textContent='Add'; btn.onclick=add; row.appendChild(btn); box.appendChild(row); parent.appendChild(box); function add(){ const val=input.value.trim(); if(val){ addToObjective(`${title} - ${val}`); input.value=''; } } }

    function generateSystemFaultLinesContent(){
      const content=document.createElement('div');
      const h4=document.createElement('h4'); h4.textContent='Neurological Gyroscope'; content.appendChild(h4);
      createCombinedNeuroGrid(content);

      // Quick-pick rows as tables
      createNumberSelector(content, 'IAR');
      createNumberSelector(content, 'NIR');
      createNumberSelector(content, 'EDR');
      createNumberSelector(content, 'PR');
      createNumberSelector(content, 'MR');
      createNumberSelector(content, 'IR');

      createNumberSelector(content, 'Zone(s) active (quick pick)');
      const advZone=document.createElement('button'); advZone.className='button'; advZone.textContent='Advanced zone selection (multi-select)'; advZone.onclick=()=>openSubModal('Zone(s) active'); content.appendChild(advZone);

      createTextInputSection(content, 'VIP');
      const vipAdv=document.createElement('button'); vipAdv.className='button'; vipAdv.style.marginLeft='8px'; vipAdv.textContent='Open VIP tree'; vipAdv.onclick=()=>openSubModal('VIP'); content.appendChild(vipAdv);

      const gyroAdv=document.createElement('button'); gyroAdv.className='button'; gyroAdv.style.marginLeft='8px'; gyroAdv.textContent='Open Gyro lines picker'; gyroAdv.onclick=()=>openSubModal('Gyro'); content.appendChild(gyroAdv);

      return content;
    }

    function createSystemFaultLinesHeader(parent){ const header=document.createElement('div'); header.className='section-header'; header.textContent='System Fault Lines'; header.onclick=()=>openModal('System Fault Lines', generateSystemFaultLinesContent()); parent.appendChild(header); }

    // Objective Findings Notes (simple adders)
    function generateObjectiveFindingsNotesContent(){
      const wrap=document.createElement('div');
      const rows=[
        {label:'Hypo-reactive Muscle:', id:'hypoInput', prefix:'Hypo-reactive Muscle: '},
        {label:'Hyper-reactive muscle:', id:'hyperInput', prefix:'Hyper-reactive muscle: '},
        {label:'Tight and tender:', id:'tightInput', prefix:'Tight and tender: '},
        {label:'Additional Notes:', id:'additionalInput', prefix:'Additional Notes: '},
      ];
      rows.forEach(r=>{ const g=document.createElement('div'); g.className='group'; const lab=document.createElement('label'); lab.innerHTML = `${r.label} <input id="${r.id}" type="text" style="padding:6px; border:1px solid #b3c7f7; border-radius:6px">`; g.appendChild(lab); const btn=document.createElement('button'); btn.className='button'; btn.textContent='Add'; btn.onclick=()=>{ const v=document.getElementById(r.id).value.trim(); if(v){ addToObjective(r.prefix+v); document.getElementById(r.id).value=''; } }; g.appendChild(btn); wrap.appendChild(g); });
      return wrap;
    }
    function createObjectiveFindingsNotesHeader(parent){ const header=document.createElement('div'); header.className='section-header'; header.textContent='Objective Findings Notes'; header.onclick=()=>openModal('Objective Findings Notes', generateObjectiveFindingsNotesContent()); parent.appendChild(header); }

    // SOT quick grid (same as before)
    function generateSotContent(){ const content=document.createElement('div'); const opts=['CAT 1','SB+ve','SB-ve','CAT 2','CAT 3','Left short Leg','Right short leg','Blocked','Supine','Prone']; const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit,minmax(120px,1fr))'; grid.style.gap='8px'; opts.forEach(o=>{ const btn=document.createElement('button'); btn.className='button'; btn.textContent=o; btn.onclick=()=>btn.classList.toggle('selected'); grid.appendChild(btn); }); content.appendChild(grid); const add=document.createElement('button'); add.className='button'; add.style.marginTop='10px'; add.textContent='Add to SOAP note'; add.onclick=()=>{ const selected=[...grid.querySelectorAll('.button.selected')].map(b=>b.textContent); if(selected.length) addToObjective('SOT: '+selected.join(', ')); closeModal(objectiveModal); }; content.appendChild(add); return content; }
    function createSotHeader(parent){ const header=document.createElement('div'); header.className='section-header'; header.textContent='SOT'; header.onclick=()=>openModal('SOT', generateSotContent()); parent.appendChild(header); }

    // Sub-modal advanced pickers (Gyro / VIP tree / Zones multi-select)
    function openSubModal(type){ subModal.dataset.type=type; subModal.style.display='block'; subModalTitle.textContent=type==='Gyro'?'Gyroscopic Adaptation Line':type; selectionGrid.innerHTML=''; document.getElementById('subExtras').innerHTML='';
      if(type==='Gyro'){
        const row=document.createElement('div'); row.className='gyro-container';
        // Left
        const leftSide=document.createElement('div'); leftSide.className='gyro-side';
        const l1=document.createElement('h4'); l1.textContent='Gyro Line 1 LEFT'; leftSide.appendChild(l1);
        const l1Btns=document.createElement('div'); l1Btns.className='gyro-buttons'; [1,2,3,4,5,6,7].forEach(n=>{ const b=document.createElement('div'); b.className='selection-button'; b.textContent=n; b.dataset.value=n+' Left'; b.onclick=()=>b.classList.toggle('selected'); l1Btns.appendChild(b); }); leftSide.appendChild(l1Btns);
        const l2=document.createElement('h4'); l2.textContent='Gyro Line 2 LEFT'; leftSide.appendChild(l2);
        const l2Btns=document.createElement('div'); l2Btns.className='gyro-buttons'; ['2/1','2/2','2/3'].forEach(n=>{ const b=document.createElement('div'); b.className='selection-button'; b.textContent=n; b.dataset.value=n+' Left'; b.onclick=()=>b.classList.toggle('selected'); l2Btns.appendChild(b); }); leftSide.appendChild(l2Btns);
        // Right
        const rightSide=document.createElement('div'); rightSide.className='gyro-side';
        const r1=document.createElement('h4'); r1.textContent='Gyro Line 1 RIGHT'; rightSide.appendChild(r1);
        const r1Btns=document.createElement('div'); r1Btns.className='gyro-buttons'; [1,2,3,4,5,6,7].forEach(n=>{ const b=document.createElement('div'); b.className='selection-button'; b.textContent=n; b.dataset.value=n+' Right'; b.onclick=()=>b.classList.toggle('selected'); r1Btns.appendChild(b); }); rightSide.appendChild(r1Btns);
        const r2=document.createElement('h4'); r2.textContent='Gyro Line 2 RIGHT'; rightSide.appendChild(r2);
        const r2Btns=document.createElement('div'); r2Btns.className='gyro-buttons'; ['2/1','2/2','2/3'].forEach(n=>{ const b=document.createElement('div'); b.className='selection-button'; b.textContent=n; b.dataset.value=n+' Right'; b.onclick=()=>b.classList.toggle('selected'); r2Btns.appendChild(b); }); rightSide.appendChild(r2Btns);
        const lineRow=document.createElement('div'); lineRow.className='gyro-line-row'; lineRow.appendChild(leftSide); lineRow.appendChild(rightSide); selectionGrid.appendChild(lineRow);
      } else if(type==='VIP'){
        // Collapsible tree
        const structure={
          'Glandular system':{'Adrenal glands':null,'Pancreas':null,'Liver':null,'Parathyroid glands':null,'Thyroid Gland':null},
          'Brain/CSF':null,
          'Respiratory system':{'Upper lung':null,'Lower Lung':null},
          'Head and neck':{'Inner Ear':null,'Nose':null,'Tongue':null,'Larynx':null,'Pharynx':null,'Tonsils':null},
          'Digestive system':{'Oesophagus':null,'Stomach':{'Cardiac Valve':null,'Body':null,'Pyloric Valve':null},'Pancreas':null,'Gallbladder':null,'Small intestine':{'Duodenum':null,'Jejunum':null,'Ileum':null},'Large intestine':{'ICV':null,'Appendix':null,'Ascending colon':null,'Transverse colon':null,'Hepatic Flexure':null,'Splenic flexure':null,'Descending colon':null,'Sigmoid colon':null,'Rectum':null}},
          'Reproductive system':{'Prostate':null,'Testes':null,'Penis':null,'Uterus':null,'Womb':null,'Vagina':null},
          'Heart':null,
          'Urinary system':{'Kidneys':null,'Ureters':null,'Urethra':null,'Bladder':null},
          'Immune system':{'Spleen':null,'Thymus gland':null,'Right Lymphatic duct':null,'Left Lymphatic duct (Thoracic Duct)':null,'Appendix':null}
        };
        function build(parent, node){ for(const k in node){ if(node[k]==null){ const b=document.createElement('div'); b.className='selection-button'; b.textContent=k; b.onclick=()=>b.classList.toggle('selected'); parent.appendChild(b);} else { const det=document.createElement('details'); const sum=document.createElement('summary'); sum.textContent=k; det.appendChild(sum); const inner=document.createElement('div'); inner.style.padding='6px 10px'; build(inner,node[k]); det.appendChild(inner); parent.appendChild(det);} } }
        build(selectionGrid, structure);
        const custom=document.createElement('input'); custom.className='selection-button'; custom.placeholder='Add custom VIP and press Enter'; custom.onkeypress=(e)=>{ if(e.key==='Enter' && custom.value.trim()){ addToObjective('VIP - '+custom.value.trim()); custom.value=''; } }; document.getElementById('subExtras').appendChild(custom);
      } else if(type==='Zone(s) active'){
        [1,2,3,4,5,6,7].forEach(n=>{ const b=document.createElement('div'); b.className='selection-button'; b.textContent='Zone '+n; b.onclick=()=>b.classList.toggle('selected'); selectionGrid.appendChild(b); });
        const note=document.createElement('p'); note.style.marginTop='8px'; note.textContent='(Select one or more zones, then choose primary when prompted)'; document.getElementById('subExtras').appendChild(note);
      } else {
        [1,2,3,4,5,6,7].forEach(n=>{ const b=document.createElement('div'); b.className='selection-button'; b.textContent=n; b.onclick=()=>b.classList.toggle('selected'); selectionGrid.appendChild(b); });
      }
    }

    function addSelectionsFromSubModal(){ const type=subModal.dataset.type; const selected=[...selectionGrid.querySelectorAll('.selection-button.selected')].map(el=>el.dataset?.value||el.textContent);
      if(!selected.length){ closeCurrentModal(); return; }
      if(type==='Gyro'){
        const L=new Set(), R=new Set(); selected.forEach(sel=>{ const [itm, side]=sel.split(' '); if(side==='Left') L.add(itm); if(side==='Right') R.add(itm); });
        const bil=[], indiv=[]; L.forEach(it=>{ if(R.has(it)){ bil.push(it); R.delete(it);} else indiv.push(`${it} Left`); }); R.forEach(it=>indiv.push(`${it} Right`));
        bil.forEach(it=>addToObjective(`Gyro: Bilateral ${it}`)); indiv.forEach(x=>addToObjective(`Gyro: ${x}`));
        closeCurrentModal(); return;
      }
      if(type==='Zone(s) active' && selected.length>1){ // ask for primary
        const prompt=document.createElement('div'); prompt.innerHTML='<h4>Which is the primary zone?</h4>'; const row=document.createElement('div'); row.className='selection-grid';
        selected.forEach(txt=>{ const b=document.createElement('div'); b.className='selection-button'; b.textContent=txt; b.onclick=()=>{ const primary=txt.split(' ')[1]; addToObjective(`Zone(s) active: ${selected.join(', ')} primary zone ${primary}`); closeCurrentModal(); }; row.appendChild(b); });
        selectionGrid.innerHTML=''; selectionGrid.appendChild(prompt); selectionGrid.appendChild(row); return; }
      // VIP, IAR, etc.
      if(type==='VIP'){ addToObjective('VIP - '+selected.join(', ')); }
      else if(type==='Zone(s) active'){ addToObjective('Zone(s) active: '+selected.join(', ')); }
      else { addToObjective(`${type}: ${selected.join(', ')}`); }
      closeCurrentModal();
    }
    function closeCurrentModal(){ subModal.style.display='none'; selectionGrid.innerHTML=''; document.getElementById('subExtras').innerHTML=''; }

    // ===== Column 2: (very light placeholders; keep your existing data lists if you had them) =====
    function selectCategory(cat, el){ document.querySelectorAll('.selectable').forEach(n=>n.classList.remove('selected')); el.classList.add('selected'); const c=document.getElementById('colBonesContent'); c.innerHTML=''; const d=document.createElement('details'); const s=document.createElement('summary'); s.textContent=cat+ ' — open to pick'; d.appendChild(s); const inner=document.createElement('div'); inner.style.display='grid'; inner.style.gridTemplateColumns='repeat(auto-fit,minmax(140px,1fr))'; inner.style.gap='8px'; const items=(cat==='Cervical')?['Occiput','Atlas/C1','Axis/C2','C3','C4','C5','C6','C7']:(cat==='Thoracic')?Array.from({length:12},(_,i)=>'T'+(i+1)):(cat==='Lumbar')?['L1','L2','L3','L4','L5']:(cat==='Pelvis')?['Ilium','Ischium','Pubis']:(cat==='Sacrum & coccyx')?['Sacrum','Coccyx']:(cat==='Extremities')?['Shoulder','Elbow','Wrist','Hip','Knee','Ankle','Foot']:(cat==='Zones')?['Zone 1','Zone 2','Zone 3','Zone 4','Zone 5','Zone 6','Zone 7']:['Frontal','Parietal','Temporal','Occipital','Sphenoid']; items.forEach(x=>{ const div=document.createElement('div'); div.className='selection-button'; div.textContent=x; div.onclick=()=>{ document.getElementById('focusField')?.remove(); }; inner.appendChild(div); }); d.appendChild(inner); c.appendChild(d); document.getElementById('addToSoapButton').style.display='block'; }

    function addToSoap(){ // very light joiner using any selected labels (for brevity)
      addToAction('Adjustment performed.'); alert('Added to SOAP (demo).'); }
    function addCustomToAction(){ const v=document.getElementById('customActionInput').value.trim(); if(v){ addToAction(v); document.getElementById('customActionInput').value=''; } }
    function addPlanExercise(){ const v=planExercise.value.trim(); if(v){ insertAtCursor(planField, 'Exercise: '+v); planExercise.value=''; saveData(); }}
    function addPlanNutrition(){ const v=planNutrition.value.trim(); if(v){ insertAtCursor(planField, 'Nutrition: '+v); planNutrition.value=''; saveData(); }}
    function addPlanCheck(){ const v=planCheck.value.trim(); if(v){ insertAtCursor(planField, 'Check next visit: '+v); planCheck.value=''; saveData(); }}

    // ===== Init =====
    window.onload = function(){ try{ const saved=localStorage.getItem('chiroData'); if(saved){ setData(JSON.parse(saved)); } }catch(e){}
      document.querySelectorAll('textarea, input[type="text"]').forEach(el=>el.addEventListener('input', ()=>{ saveData(); saveSnapshot(); }));
      saveSnapshot(true); status.textContent='Ready. Data auto-saves.';
      const objectiveCol=document.getElementById('objectiveContent');
      createPalpatoryFindingsHeader(objectiveCol);
      createSystemFaultLinesHeader(objectiveCol);
      createObjectiveFindingsNotesHeader(objectiveCol);
      createSotHeader(objectiveCol);

      // Desktop-only gate
      const isNarrow = window.innerWidth < 1000; const isMobileUA = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if(isNarrow || isMobileUA){ document.getElementById('desktopOnly').style.display='flex'; }
    };
  </script>
</body>
</html>


